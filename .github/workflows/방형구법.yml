<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©í˜•êµ¬ë²• ì—°ìŠµ ë†€ì´(by. ëª…ì„ ìŒ¤)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #e6f7ff; /* Very Light Blue for sea theme */
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
            text-align: right;
            border-radius: 0.5rem;
            border: 2px solid #0ea5e9; /* Sky Blue */
            background-color: #fff;
            padding: 0.5rem 0.75rem;
            width: 70px; /* ì…ë ¥ í•„ë“œë„ ì•½ê°„ ì¶•ì†Œ */
            transition: all 0.2s;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #0284c7;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.5);
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .correct { 
            background-color: #dcfce7;
            border-color: #4ade80;
        }
        .incorrect { 
            background-color: #fee2e2;
            border-color: #f87171;
        }
        .quadrat-map-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .quadrat-map {
            border: 5px solid #075985; /* Darker Blue Border */
            background-color: #cffafe; /* Cyan Lightest */
            border-radius: 1.5rem;
            box-shadow: 0 15px 25px rgba(0,0,0,0.2);
            /* V11: Canvas size reduction */
            width: 100%;
            max-width: 780px; /* 13 * 60 = 780px */
            height: 420px; /* 7 * 60 = 420px */
        }
        .btn-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .rules-box {
            background-color: #e0f2fe; /* Light blue background */
            border: 1px solid #90cdf4; /* Soft blue border */
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 0.85rem; /* Smaller font size for rules */
            color: #2b6cb0; /* Darker blue text */
        }
        .rules-box h3 {
            font-weight: bold;
            color: #1a4f89;
            margin-bottom: 0.5rem;
        }
        .rules-box p {
            line-height: 1.4;
        }
        /* ì…ë ¥ í•„ë“œ í¬ê¸° ì¡°ì • */
        #calc-table input[type="number"] {
            width: 65px; 
            padding: 0.25rem 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-6">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-3xl p-6 md:p-8 border-4 border-sky-400">

        <h1 class="text-3xl font-extrabold text-center text-blue-700 mb-4">ğŸŒŠ ë°©í˜•êµ¬ë²• ì—°ìŠµ ë†€ì´(by. ëª…ì„ ìŒ¤)</h1>
        <p class="text-center text-gray-500 mb-8 text-sm">
            <span class="font-bold">ì´ ì¡°ì‚¬ ë©´ì : 45.0ã¡</span> (5ê°œ ë°©í˜•êµ¬, ê° 3m x 3m ê·¸ë¦¬ë“œ). 
            <br>1ã¡ ê·¸ë¦¬ë“œ ì…€ì€ 60px x 60px ì •ì‚¬ê°í˜•ì…ë‹ˆë‹¤.
        </p>
        
        <div class="mb-8 p-4 bg-blue-50 rounded-2xl shadow-inner border border-blue-200">
            <h2 class="text-xl font-bold text-blue-700 mb-3 flex items-center">
                <span class="mr-2">ğŸ—ºï¸</span> Step 1: ê³ ë˜ë°¥ ì„œì‹ì§€ ê´€ì°° ë° ë°ì´í„° ìˆ˜ì§‘
            </h2>

            

<div class="rules-box">
                <h3>ì°¸ê³ : êµ°ì§‘ ì¡°ì‚¬ ê·œì¹™</h3>
                <p class="mb-1">
                    **1. ì¡°ì‚¬ ë‹¨ìœ„:** 1m x 1m(ì¦‰ 1ã¡)ì˜ ì…€ì„ ê°€ì§„ 5ê°œì˜ ë°©í˜•êµ¬ì—ì„œ êµ°ì§‘ ì¡°ì‚¬ë¥¼ í•œë‹¤.
                </p>
                <p class="mb-1">
                    **2. í”¼ë„(Ci) ê·œì¹™:** í•œ ì¹¸ì— ì¶œí˜„í•œ ì¢…ì€ ê·¸ ì¹¸(1m x 1m(ì¦‰ 1ã¡))ì„ ëª¨ë‘ ì°¨ì§€í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼í•œë‹¤.
                </p>
                <p class="mb-1">
                    **3. ë°€ë„(D)** = íŠ¹ì • ì¢…ì˜ ê°œì²´ ìˆ˜ / ì „ì²´ ë°©í˜•êµ¬ì˜ ë©´ì (ã¡)
                </p>
                <p class="mb-1">
                    **4. ë¹ˆë„(F)** = íŠ¹ì • ì¢…ì´ ì¶œí˜„í•œ ë°©í˜•êµ¬ ìˆ˜ / ì „ì²´ ë°©í˜•êµ¬ì˜ ìˆ˜
                </p>
                <p class="mb-1">
                    **5. í”¼ë„(Cv)** = íŠ¹ì • ì¢…ì˜ ì ìœ  ë©´ì (ã¡) / ì „ì²´ ë°©í˜•êµ¬ì˜ ë©´ì (ã¡)
                </p>
                <p class="mb-1">
                    **6. ìƒëŒ€ ë°€ë„/ë¹ˆë„/í”¼ë„(%)** = (íŠ¹ì • ì¢…ì˜ ë°€ë„/ë¹ˆë„/í”¼ë„ / ì¡°ì‚¬í•œ ëª¨ë“  ì¢…ì˜ ë°€ë„/ë¹ˆë„/í”¼ë„ í•©) x 100
                </p>
                <p class="mb-1">
                    **7. ì¤‘ìš”ì¹˜(IV)** = ìƒëŒ€ ë°€ë„ + ìƒëŒ€ ë¹ˆë„ + ìƒëŒ€ í”¼ë„
                </p>
            </div>
            
            <div class="flex flex-wrap justify-center space-x-6 mb-4 text-sm font-semibold p-3 bg-white rounded-xl shadow-md border border-gray-100">
                <span class="text-gray-700">ğŸ” ì¢… ëª©ë¡:</span>
                <span class="flex items-center">ğŸ³ ê³ ë˜</span>
                <span class="flex items-center">ğŸ¦ ìƒˆìš°</span>
                <span class="flex items-center">â­ ë¶ˆê°€ì‚¬ë¦¬</span>
            </div>

            <div class="quadrat-map-container">
                

<canvas id="quadrat-map" class="quadrat-map" width="780" height="420"></canvas>
            </div>
            <p class="text-center text-gray-600 mt-2 text-sm">ë§µì˜ ê° ì…€ì€ 1ã¡ (60px x 60px) ì…ë‹ˆë‹¤.</p>
        </div>

        <div class="mb-8 p-6 bg-green-100 rounded-2xl shadow-lg border border-green-300">
            <h3 class="text-lg font-bold text-green-800 mb-4 flex items-center">
                <span class="mr-2">ğŸ”¢</span> Step 1 ë¯¸ì…˜: ìˆ˜ì§‘ ë°ì´í„° ì…ë ¥
            </h3>
            <div class="overflow-x-auto">
                <table id="raw-data-table" class="min-w-full divide-y divide-green-300 border border-green-300 rounded-lg">
                    <thead class="bg-green-200">
                        <tr>
                            <th class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase">ì¢…ë¥˜</th>
                            <th class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase">ì´ ê°œì²´ìˆ˜ (Ni)</th>
                            <th class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase">ì¶œí˜„ ë°©í˜•êµ¬ ìˆ˜ (Qi) (ì´ 5ê°œ ì¤‘)</th>
                            <th class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase">ì´ í”¼ë„ ë©´ì  (Ci) (ã¡)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <button id="check-step1" onclick="checkStep1Answers()" class="mt-6 px-8 py-3 w-full bg-green-500 text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition btn-shadow">
                Step 1 ë°ì´í„° ìˆ˜ì§‘ ê²°ê³¼ í™•ì¸
            </button>
            <p id="step1-message" class="text-center mt-4 text-sm font-semibold text-gray-800"></p>
        </div>

        <div class="mb-8 p-6 bg-purple-100 rounded-2xl shadow-lg border border-purple-300" id="step2-container" style="display:none;">
            <h2 class="text-xl font-bold text-purple-700 mb-4 flex items-center">
                <span class="mr-2">ğŸ§®</span> Step 2: êµ°ì§‘ ë¶„ì„ ê³„ì‚° (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€)
            </h2>
            <p class="text-gray-700 mb-4 text-sm font-bold">
                ì´ ë°©í˜•êµ¬ ìˆ˜(Q)=5, ì´ ë©´ì (A)=45.0ã¡ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ë©°, **ëª¨ë“  ì¸¡ì •ì¹˜ëŠ” ì†Œìˆ˜ì  ì…‹ì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼í•˜ì—¬ ë‘˜ì§¸ ìë¦¬ê¹Œì§€** ì…ë ¥í•˜ì„¸ìš”.
            </p>

            <div class="overflow-x-auto">
                <table id="calc-table" class="min-w-full divide-y divide-purple-300 border border-purple-300 rounded-lg text-sm">
                    <thead class="bg-purple-200">
                        <tr>
                            <th rowspan="2" class="px-2 py-3 text-center text-xs font-bold text-gray-700">ì¢…ë¥˜</th>
                            <th colspan="3" class="px-2 py-2 text-center text-xs font-bold text-gray-700 border-b border-purple-300">ê¸°ë³¸ ì¸¡ì •ì¹˜ (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬)</th>
                            <th colspan="3" class="px-2 py-2 text-center text-xs font-bold text-gray-700 border-b border-purple-300">ìƒëŒ€ ì¸¡ì •ì¹˜ (%) (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬)</th>
                            <th rowspan="2" class="px-2 py-3 text-center text-xs font-bold text-gray-700">ì¤‘ìš”ì¹˜ (IV) (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬)</th>
                        </tr>
                        <tr>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">ë°€ë„(D) (ê°œì²´/ã¡)</th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">ë¹ˆë„(F) (ì¶œí˜„ìœ¨)</th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">í”¼ë„(Cv) (ì ìœ ìœ¨)</th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">ìƒëŒ€ë°€ë„(RD)</th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">ìƒëŒ€ë¹ˆë„(RF)</th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">ìƒëŒ€í”¼ë„(RC)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                    <tfoot class="bg-gray-100 font-bold">
                        <tr>
                            <td class="px-2 py-2 text-center">í•©ê³„ (Î£)</td>
                            <td id="sum-D" class="px-2 py-2 text-right"></td>
                            <td id="sum-F" class="px-2 py-2 text-right"></td>
                            <td id="sum-C" class="px-2 py-2 text-right"></td>
                            <td id="sum-RD" class="px-2 py-2 text-right"></td>
                            <td id="sum-RF" class="px-2 py-2 text-right"></td>
                            <td id="sum-RC" class="px-2 py-2 text-right"></td>
                            <td id="sum-IV" class="px-2 py-2 text-purple-700 text-center"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-6 flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <button id="check-step2" onclick="checkStep2Answers()" class="px-8 py-3 bg-fuchsia-600 text-white font-bold rounded-xl shadow-lg hover:bg-fuchsia-700 transition duration-300 btn-shadow">
                    Step 2 ìµœì¢… ì •ë‹µ í™•ì¸ ë° ìš°ì ì¢… ì°¾ê¸°
                </button>
                <div id="step2-message" class="text-lg font-bold text-gray-800 p-3 bg-white rounded-lg shadow-md min-w-[200px] text-center border-2 border-dashed border-gray-300">
                    ê³„ì‚° ê²°ê³¼ë¥¼ ì…ë ¥í•˜ê³  í™•ì¸í•˜ì„¸ìš”.
                </div>
            </div>

            <div id="dominant-species-result" class="mt-8 p-5 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg hidden">
                <h3 class="text-2xl font-bold text-yellow-700 mb-2 flex items-center">ğŸ‘‘ ë¯¸ì…˜ ì„±ê³µ! ìš°ì ì¢…ì„ ì°¾ì•˜ì–´ìš”!</h3>
                <p id="dominant-species-text" class="text-xl text-yellow-800"></p>
            </div>
        </div>
        
        <div class="mt-8 flex justify-center">
            <button id="regenerateBtn" onclick="initializeGame()" class="px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition btn-shadow">
                ë°ì´í„° ë‹¤ì‹œ ìƒì„± (ìƒˆë¡œìš´ ì„œì‹ì§€ ì¡°ì‚¬)
            </button>
        </div>


    </div>

    <script>
        // --- ìƒìˆ˜ ì •ì˜ (Constants) ---
        const TOTAL_QUADRATS = 5; // ì´ ë°©í˜•êµ¬ ìˆ˜ 
        const QUADRAT_CELL_SIZE = 3; // ê° ë°©í˜•êµ¬ëŠ” 3x3 ê·¸ë¦¬ë“œ (3m x 3m)
        const TOTAL_AREA_PER_QUADRAT_M2 = QUADRAT_CELL_SIZE * QUADRAT_CELL_SIZE; // ê° ë°©í˜•êµ¬ ë©´ì  = 9 ã¡
        const TOTAL_AREA_M2 = TOTAL_QUADRATS * TOTAL_AREA_PER_QUADRAT_M2; // ì´ ë©´ì  = 5 * 9 = 45.0 ã¡
        
        // V10/V11/V12/V13/V14: ë§µ í¬ê¸° ë° ê²©ì ì¡°ì • (13W x 7H)
        const GRID_CANVAS_WIDTH = 13; 
        const GRID_CANVAS_HEIGHT = 7; 
        const CELL_PIXEL_SIZE = 60; // 1ã¡ ì…€ì˜ í¬ê¸° (60px)
        const CANVAS_WIDTH_PX = GRID_CANVAS_WIDTH * CELL_PIXEL_SIZE; // 13 * 60 = 780
        const CANVAS_HEIGHT_PX = GRID_CANVAS_HEIGHT * CELL_PIXEL_SIZE; // 7 * 60 = 420
        
        // V13/V14: ì†Œìˆ˜ì  ì…‹ì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼í•˜ì—¬ ë‘˜ì§¸ ìë¦¬ê¹Œì§€ í—ˆìš© ì˜¤ì°¨ ì¡°ì • (0.015)
        const ROUNDING_TOLERANCE = 0.015; 

        // ì¢…ë³„ ì‹œê° ì •ë³´ ë° ìµœëŒ€ ê°œì²´ ìˆ˜
        const speciesInfo = {
            'ê³ ë˜': { symbol: 'ğŸ³', maxCount: 1, baseProb: 0.15, multiCountProb: 0.0 },
            'ìƒˆìš°': { symbol: 'ğŸ¦', maxCount: 3, baseProb: 0.35, multiCountProb: 0.1 }, 
            'ë¶ˆê°€ì‚¬ë¦¬': { symbol: 'â­', maxCount: 3, baseProb: 0.30, multiCountProb: 0.1 }
        };

        // V8/V9/V10/V11/V12/V13/V14: ë°©í˜•êµ¬ ì¢Œí‘œ
        const quadratStartCoords = {
            1: { x: 0, y: 0 },   
            2: { x: 5, y: 0 },   
            3: { x: 10, y: 0 },  
            4: { x: 2, y: 4 },   
            5: { x: 7, y: 4 }    
        };

        let cellContents = {}; 
        let generatedSnackLocations = {}; 

        // --- ë°ì´í„° ìƒì„± í•¨ìˆ˜ (ìƒëµë˜ì§€ ì•ŠìŒ) ---
        function generateRandomLocations() {
            generatedSnackLocations = { 'ê³ ë˜': [], 'ìƒˆìš°': [], 'ë¶ˆê°€ì‚¬ë¦¬': [] };
            cellContents = {}; 
            const speciesKeys = Object.keys(speciesInfo);

            for (let qId = 1; qId <= TOTAL_QUADRATS; qId++) {
                const qStart = quadratStartCoords[qId];

                for (let dx = 0; dx < QUADRAT_CELL_SIZE; dx++) {
                    for (let dy = 0; dy < QUADRAT_CELL_SIZE; dy++) {
                        const cellX = qStart.x + dx;
                        const cellY = qStart.y + dy;
                        const cellKey = `${cellX},${cellY}`;
                        cellContents[cellKey] = {}; 

                        speciesKeys.forEach(speciesName => {
                            const info = speciesInfo[speciesName];
                            let count = 0;

                            if (Math.random() < info.baseProb) {
                                count = 1;
                                if (speciesName !== 'ê³ ë˜' && Math.random() < info.multiCountProb) {
                                    count = Math.floor(Math.random() * (info.maxCount - 1)) + 2; 
                                }
                            }
                            
                            if (count > 0) {
                                cellContents[cellKey][speciesName] = count;
                                for (let i = 0; i < count; i++) {
                                    generatedSnackLocations[speciesName].push({ x: cellX, y: cellY, q: qId });
                                }
                            }
                        });
                    }
                }
            }
        }


        // --- ë³´ì¡° í•¨ìˆ˜ ---
        // V14: ëª¨ë“  ì¸¡ì •ì¹˜ ê³„ì‚°ì„ ìœ„í•œ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ ë°˜ì˜¬ë¦¼ í•¨ìˆ˜ (ì…‹ì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼)
        const toTwoDecimals = (value) => Math.round(value * 100) / 100;
        
        function getCorrectRawData() {
            const data = [];
            
            Object.keys(speciesInfo).forEach(name => {
                const locations = generatedSnackLocations[name];
                const Ni = locations.length; 
                
                const uniqueQuadrats = new Set(locations.map(loc => loc.q));
                const Qi = uniqueQuadrats.size;

                const presentCells = new Set();
                locations.forEach(loc => presentCells.add(`${loc.x},${loc.y}`));
                const Ci = presentCells.size; 

                data.push({ name, Ni, Qi, Ci });
            });
            return data;
        }

        let correctRawDataForGame = []; 

        function calculateCorrectAnswers() {
            let results = {};
            let sumD_precise = 0;
            let sumF_precise = 0;
            let sumCv_precise = 0;

            correctRawDataForGame.forEach(s => {
                const D = s.Ni / TOTAL_AREA_M2;
                sumD_precise += D;

                const F = s.Qi / TOTAL_QUADRATS;
                sumF_precise += F;

                const Cv = s.Ci / TOTAL_AREA_M2;
                sumCv_precise += Cv;

                // V14: D, F, Cvë„ toTwoDecimals ì ìš©
                results[s.name] = { 
                    D: toTwoDecimals(D), 
                    F: toTwoDecimals(F), 
                    Cv: toTwoDecimals(Cv) 
                };
            });
            
            // --- FIX 1: ëˆ„ì ëœ ìƒëŒ€ ì¸¡ì •ì¹˜ í•©ê³„ ë³€ìˆ˜ ì„ ì–¸ ---
            let sumRD_rounded = 0;
            let sumRF_rounded = 0;
            let sumRC_rounded = 0;
            // ----------------------------------------------

            correctRawDataForGame.forEach(s => {
                const preciseD = s.Ni / TOTAL_AREA_M2;
                const preciseF = s.Qi / TOTAL_QUADRATS;
                const preciseCv = s.Ci / TOTAL_AREA_M2;

                // V14: ìƒëŒ€ ë°€ë„/ë¹ˆë„/í”¼ë„ëŠ” toTwoDecimalsë¥¼ ì‚¬ìš©í•˜ì—¬ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼
                // ì£¼ì˜: ìƒëŒ€ê°’ ê³„ì‚° ì‹œ ë¶„ëª¨ëŠ” ë°˜ì˜¬ë¦¼ë˜ì§€ ì•Šì€ ì •ë°€í•œ í•©ê³„ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
                const RD = sumD_precise > 0 ? toTwoDecimals((preciseD / sumD_precise) * 100) : 0.00;
                const RF = sumF_precise > 0 ? toTwoDecimals((preciseF / sumF_precise) * 100) : 0.00;
                const RC = sumCv_precise > 0 ? toTwoDecimals((preciseCv / sumCv_precise) * 100) : 0.00;
                
                // V14: ì¤‘ìš”ì¹˜(IV)ë„ toTwoDecimalsë¥¼ ì‚¬ìš©í•˜ì—¬ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼
                const IV = toTwoDecimals(RD + RF + RC);

                results[s.name] = {
                    ...results[s.name], // D, F, Cv (2ì§¸ ìë¦¬)
                    RD, RF, RC, IV
                };

                // --- FIX 1: ìƒëŒ€ ì¸¡ì •ì¹˜ í•©ê³„ë¥¼ ëˆ„ì  ---
                sumRD_rounded += RD;
                sumRF_rounded += RF;
                sumRC_rounded += RC;
                // --------------------------------------
            });
            
            // í•©ê³„ëŠ” ì •ë°€í•œ í•©ê³„ë¥¼ toTwoDecimalsë¡œ ê³„ì‚° (ì‹¤ì‹œê°„ ê³„ì‚°ì„ ìœ„í•´ ì´ˆê¸°ê°’ì€ 0)
            const sumD_display = toTwoDecimals(sumD_precise);
            const sumF_display = toTwoDecimals(sumF_precise);
            const sumCv_display = toTwoDecimals(sumCv_precise);
            
            // --- FIX 1: ëˆ„ì ëœ ìƒëŒ€ ì¸¡ì •ì¹˜ í•©ê³„ë¥¼ ìµœì¢… ë°˜ì˜¬ë¦¼í•˜ì—¬ ì €ì¥ ---
            const sumRD_display = toTwoDecimals(sumRD_rounded);
            const sumRF_display = toTwoDecimals(sumRF_rounded);
            const sumRC_display = toTwoDecimals(sumRC_rounded);
            // -------------------------------------------------------------
            
            // ì¤‘ìš”ì¹˜ í•©ê³„ ê³„ì‚°
            let sumIV = 0; 
            Object.keys(results).forEach(name => {
                sumIV += results[name].IV;
            });
            
            // IV í•©ê³„ë„ toTwoDecimalsë¡œ ê³„ì‚°
            const sumIV_display = toTwoDecimals(sumIV); 

            return {
                species: results,
                sums: { 
                    sumD: sumD_display, 
                    sumF: sumF_display, 
                    sumCv: sumCv_display,
                    sumRD: sumRD_display, // FIXED: ê³„ì‚°ëœ í•©ê³„ ì‚¬ìš©
                    sumRF: sumRF_display, // FIXED: ê³„ì‚°ëœ í•©ê³„ ì‚¬ìš©
                    sumRC: sumRC_display, // FIXED: ê³„ì‚°ëœ í•©ê³„ ì‚¬ìš©
                    sumIV: sumIV_display // ì •ë°€ ê³„ì‚°ëœ IV í•©ê³„
                }
            };
        }

        let correctStep2Answers = {}; 
        
        // --- UI ë Œë”ë§ ë° ê²Œì„ ë¡œì§ í•¨ìˆ˜ ---

        function drawQuadratMap() {
            const canvas = document.getElementById('quadrat-map');
            if (!canvas.getContext) return;
            const ctx = canvas.getContext('2d');

            const width = CANVAS_WIDTH_PX;
            const height = CANVAS_HEIGHT_PX;
            const overallCellSize = CELL_PIXEL_SIZE; // 60px

            // ë°°ê²½ (ë°”ë‹¤ ëŠë‚Œ)
            ctx.fillStyle = '#cffafe'; 
            ctx.fillRect(0, 0, width, height);

            // ì „ì²´ 13x7 ê·¸ë¦¬ë“œ ì„  ê·¸ë¦¬ê¸° (ì—°í•œ ìƒ‰)
            ctx.lineWidth = 0.5;
            ctx.strokeStyle = '#93c5fd'; 

            for (let i = 0; i <= GRID_CANVAS_WIDTH; i++) {
                ctx.beginPath();
                ctx.moveTo(i * overallCellSize, 0);
                ctx.lineTo(i * overallCellSize, height);
                ctx.stroke();
            }

            for (let i = 0; i <= GRID_CANVAS_HEIGHT; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * overallCellSize);
                ctx.lineTo(width, i * overallCellSize);
                ctx.stroke();
            }


            // 5ê°œ ì£¼ìš” ë°©í˜•êµ¬ (3x3) ê²½ê³„ì„  ê·¸ë¦¬ê¸°
            const quadratBorderColor = '#075985'; 
            ctx.lineWidth = 3;

            Object.keys(quadratStartCoords).forEach(qId => {
                const startX = quadratStartCoords[qId].x * overallCellSize;
                const startY = quadratStartCoords[qId].y * overallCellSize;
                const quadratWidth = QUADRAT_CELL_SIZE * overallCellSize;
                const quadratHeight = QUADRAT_CELL_SIZE * overallCellSize;

                ctx.strokeStyle = quadratBorderColor;
                ctx.strokeRect(startX, startY, quadratWidth, quadratHeight);

                // ë°©í˜•êµ¬ ë²ˆí˜¸ ë¼ë²¨ í‘œì‹œ
                ctx.fillStyle = quadratBorderColor;
                ctx.font = 'bold 20px Noto Sans KR'; // í°íŠ¸ í¬ê¸° ì¡°ì •
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`Q${qId}`, startX + quadratWidth / 2, startY + quadratHeight / 2);
            });


            // í•´ì–‘ ê°œì²´ ë°°ì¹˜
            const positions = [
                // 1ã¡ ì¹¸ ë‚´ë¶€ì˜ ìƒëŒ€ ìœ„ì¹˜ (ì¤‘ì•™ì„ 0,0ìœ¼ë¡œ ê°„ì£¼, -0.3 ~ 0.3 ë²”ìœ„)
                { dx: 0.0, dy: 0.0 },  // 1. Center (ê³ ë˜ ì „ìš©)
                { dx: -0.25, dy: -0.25 }, // 2. Top-Left
                { dx: 0.25, dy: -0.25 },  // 3. Top-Right
                { dx: -0.25, dy: 0.25 }, // 4. Bottom-Left
                { dx: 0.25, dy: 0.25 },   // 5. Bottom-Right
                { dx: 0.0, dy: -0.35 },  // 6. Top-Center
                { dx: 0.0, dy: 0.35 }    // 7. Bottom-Center
            ];
            
            Object.keys(cellContents).forEach(cellKey => {
                const [cellX, cellY] = cellKey.split(',').map(Number);
                const itemsInCell = cellContents[cellKey];

                const centerX = cellX * overallCellSize + overallCellSize / 2;
                const centerY = cellY * overallCellSize + overallCellSize / 2;

                const speciesInCell = Object.keys(itemsInCell).filter(s => itemsInCell[s] > 0);
                
                let currentItemIndex = 0; 

                // 1. ê³ ë˜(ìµœëŒ€ 1ê°œì²´)ëŠ” í•­ìƒ ì¤‘ì•™ (position 0)
                if (itemsInCell['ê³ ë˜'] === 1) {
                    const pos = positions[0];
                    const drawX = centerX + pos.dx * overallCellSize;
                    const drawY = centerY + pos.dy * overallCellSize;
                    
                    const fontSize = overallCellSize * 0.6; // ê³ ë˜ëŠ” ë” í¬ê²Œ
                    ctx.font = `${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(speciesInfo['ê³ ë˜'].symbol, drawX, drawY);
                    
                    currentItemIndex++;
                }

                // 2. ë‹¤ë¥¸ ì¢…ë“¤ ë°°ì¹˜ (ê³ ë˜ê°€ ì¤‘ì•™ì„ ì°¨ì§€í–ˆìœ¼ë¯€ë¡œ index 1ë¶€í„° ì‹œì‘)
                const startPosIndex = itemsInCell['ê³ ë˜'] === 1 ? 1 : 0;
                currentItemIndex = startPosIndex;

                speciesInCell.filter(name => name !== 'ê³ ë˜').forEach(speciesName => {
                    const count = itemsInCell[speciesName];
                    const symbol = speciesInfo[speciesName].symbol;
                    const fontSize = overallCellSize * 0.4; 

                    for (let i = 0; i < count; i++) {
                        if (currentItemIndex < positions.length) {
                            const pos = positions[currentItemIndex];
                            
                            const drawX = centerX + pos.dx * overallCellSize;
                            const drawY = centerY + pos.dy * overallCellSize;
                            
                            ctx.font = `${fontSize}px Arial`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(symbol, drawX, drawY);
                            
                            currentItemIndex++; 
                        }
                    }
                });
            });
        }

        function renderRawDataTable() {
            const tbody = document.querySelector('#raw-data-table tbody');
            tbody.innerHTML = Object.keys(speciesInfo).map(name => `
                <tr id="raw-row-${name}" class="hover:bg-green-50 transition duration-150">
                    <td class="px-3 py-2 text-center font-bold text-gray-900">${speciesInfo[name].symbol} ${name}</td>
                    <td class="px-3 py-1 text-center"><input type="number" id="${name}-Ni-raw" placeholder="ê°œì²´ìˆ˜" data-metric="Ni"></td>
                    <td class="px-3 py-1 text-center"><input type="number" id="${name}-Qi-raw" placeholder="Q ìˆ˜" data-metric="Qi"></td>
                    <td class="px-3 py-1 text-center"><input type="number" id="${name}-Ci-raw" placeholder="ë©´ì " data-metric="Ci"></td>
                </tr>
            `).join('');
        }

        function renderCalcTable() {
            const tbody = document.querySelector('#calc-table tbody');
            tbody.innerHTML = Object.keys(speciesInfo).map(name => `
                <tr id="calc-row-${name}" class="hover:bg-purple-50 transition duration-150">
                    <td class="px-2 py-2 text-center font-bold text-gray-900">${name}</td>
                    <!-- V14: D, F, Cvë„ step="0.01"ë¡œ ë³€ê²½ -->
                    <td class="px-2 py-1 text-center"><input type="number" id="${name}-D" placeholder="D" data-metric="D" step="0.01" oninput="updateStep2Sums()"></td>
                    <td class="px-2 py-1 text-center"><input type="number" id="${name}-F" placeholder="F" data-metric="F" step="0.01" oninput="updateStep2Sums()"></td>
                    <td class="px-2 py-1 text-center"><input type="number" id="${name}-Cv" placeholder="Cv" data-metric="Cv" step="0.01" oninput="updateStep2Sums()"></td>
                    <td class="px-2 py-1 text-center"><input type="number" id="${name}-RD" placeholder="RD" data-metric="RD" step="0.01" oninput="updateStep2Sums()"></td>
                    <td class="px-2 py-1 text-center"><input type="number" id="${name}-RF" placeholder="RF" data-metric="RF" step="0.01" oninput="updateStep2Sums()"></td>
                    <td class="px-2 py-1 text-center"><input type="number" id="${name}-RC" placeholder="RC" data-metric="RC" step="0.01" oninput="updateStep2Sums()"></td>
                    <td class="px-2 py-1 text-center"><input type="number" id="${name}-IV" placeholder="IV" data-metric="IV" step="0.01" oninput="updateStep2Sums()"></td>
                </tr>
            `).join('');

            // V14: í•©ê³„ëŠ” ì´ˆê¸°í™” ì‹œ ë¹„ì›Œë‘¡ë‹ˆë‹¤. ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤.
            document.getElementById('sum-D').textContent = '';
            document.getElementById('sum-F').textContent = '';
            document.getElementById('sum-C').textContent = '';
            document.getElementById('sum-RD').textContent = '';
            document.getElementById('sum-RF').textContent = '';
            document.getElementById('sum-RC').textContent = '';
            document.getElementById('sum-IV').textContent = '';
        }

        function updateStep2Sums() {
            const metrics = ['D', 'F', 'Cv', 'RD', 'RF', 'RC', 'IV'];
            const sums = {};

            metrics.forEach(metric => {
                sums[metric] = 0;
            });

            Object.keys(speciesInfo).forEach(name => {
                metrics.forEach(metric => {
                    const inputElement = document.getElementById(`${name}-${metric}`);
                    const value = parseFloat(inputElement.value);
                    if (!isNaN(value)) {
                        sums[metric] += value;
                    }
                });
            });

            // í•©ê³„ ì—…ë°ì´íŠ¸ (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œ)
            document.getElementById('sum-D').textContent = sums.D > 0 ? sums.D.toFixed(2) : '';
            document.getElementById('sum-F').textContent = sums.F > 0 ? sums.F.toFixed(2) : '';
            document.getElementById('sum-C').textContent = sums.Cv > 0 ? sums.Cv.toFixed(2) : '';
            document.getElementById('sum-RD').textContent = sums.RD > 0 ? sums.RD.toFixed(2) : '';
            document.getElementById('sum-RF').textContent = sums.RF > 0 ? sums.RF.toFixed(2) : '';
            document.getElementById('sum-RC').textContent = sums.RC > 0 ? sums.RC.toFixed(2) : '';
            document.getElementById('sum-IV').textContent = sums.IV > 0 ? sums.IV.toFixed(2) : '';

            // íŠ¹ìˆ˜ í•©ê³„ ê°’ (RD, RF, RC, IV)ì— ëŒ€í•œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½
            document.getElementById('sum-RD').classList.toggle('text-green-600', sums.RD > 0);
            document.getElementById('sum-RF').classList.toggle('text-green-600', sums.RF > 0);
            document.getElementById('sum-RC').classList.toggle('text-purple-700', sums.RC > 0);
            document.getElementById('sum-IV').classList.toggle('text-purple-700', sums.IV > 0);
        }

        function checkStep1Answers() {
            let allCorrect = true;
            let correctCount = 0;
            const totalMetrics = Object.keys(speciesInfo).length * 3; 
            const resultMessage = document.getElementById('step1-message');

            Object.keys(speciesInfo).forEach(name => {
                const correct = correctRawDataForGame.find(s => s.name === name);

                ['Ni', 'Qi', 'Ci'].forEach(metric => {
                    const inputElement = document.getElementById(`${name}-${metric}-raw`);
                    // Number() ëŒ€ì‹  parseInt()ë¥¼ ì‚¬ìš©í•˜ê³ , isNaN ì²´í¬ ì „ì— .valueë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    const userAnswer = parseInt(inputElement.value);
                    const correctAnswer = correct[metric];

                    if (!isNaN(userAnswer) && userAnswer === correctAnswer) {
                        inputElement.classList.remove('incorrect');
                        inputElement.classList.add('correct');
                        correctCount++;
                    } else {
                        inputElement.classList.remove('correct');
                        inputElement.classList.add('incorrect');
                        allCorrect = false;
                    }
                });
            });

            if (allCorrect) {
                resultMessage.textContent = `ğŸ‰ Step 1 ì™„ë²½ ì„±ê³µ! ë°ì´í„° ìˆ˜ì§‘ì„ ì •í™•íˆ ì™„ë£Œí–ˆì–´ìš”. ì´ì œ Step 2ë¡œ ì´ë™í•˜ì„¸ìš”.`;
                resultMessage.classList.remove('text-red-600', 'text-gray-800');
                resultMessage.classList.add('text-green-600');
                document.getElementById('step2-container').style.display = 'block'; 
                document.getElementById('check-step1').disabled = true;
                document.getElementById('check-step1').classList.replace('bg-green-500', 'bg-gray-400');
                // V14: Step 1ì´ í†µê³¼ë˜ë©´ Step 2ì˜ í•©ê³„ë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                updateStep2Sums();
            } else {
                resultMessage.textContent = `ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”! (${correctCount}/${totalMetrics} ì •ë‹µ) ì§€ë„ì—ì„œ ê°œì²´ìˆ˜(Ni), ì¶œí˜„ ë°©í˜•êµ¬ ìˆ˜(Qi), ì´ í”¼ë„ ë©´ì (Ci)ì„ ë‹¤ì‹œ ì„¸ì–´ë³´ì„¸ìš”.`;
                resultMessage.classList.remove('text-green-600', 'text-gray-800');
                resultMessage.classList.add('text-red-600');
                document.getElementById('step2-container').style.display = 'none'; 
            }
        }


        function checkStep2Answers() {
            let allCorrect = true;
            let maxIV = -1;
            let dominantSpecies = "";
            let correctCount = 0;
            const totalMetrics = Object.keys(speciesInfo).length * 7; 
            
            Object.keys(speciesInfo).forEach(name => {
                const correct = correctStep2Answers.species[name];
                
                // D, F, Cv, RD, RF, RC, IV ëª¨ë‘ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ í—ˆìš© ì˜¤ì°¨ ì ìš©
                ['D', 'F', 'Cv', 'RD', 'RF', 'RC', 'IV'].forEach(metric => {
                    const inputElement = document.getElementById(`${name}-${metric}`);
                    const userAnswer = parseFloat(inputElement.value);
                    const correctAnswer = correct[metric];
                    
                    // V14: ëª¨ë“  ì¸¡ì •ì¹˜ì— ëŒ€í•´ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ ê¸°ì¤€ í—ˆìš© ì˜¤ì°¨ ì ìš© (0.015)
                    const tolerance = ROUNDING_TOLERANCE; 

                    const isMetricCorrect = !isNaN(userAnswer) && Math.abs(userAnswer - correctAnswer) < tolerance; 
                    
                    if (isMetricCorrect) {
                        inputElement.classList.remove('incorrect');
                        inputElement.classList.add('correct');
                        correctCount++;
                    } else {
                        inputElement.classList.remove('correct');
                        inputElement.classList.add('incorrect');
                        allCorrect = false; // í•˜ë‚˜ë¼ë„ í‹€ë¦¬ë©´ ìµœì¢… ì‹¤íŒ¨
                    }

                });

                if (correct.IV > maxIV) {
                    maxIV = correct.IV;
                    dominantSpecies = name;
                }
            });

            const resultMessage = document.getElementById('step2-message');
            const dominantSpeciesResultDiv = document.getElementById('dominant-species-result');
            const dominantSpeciesText = document.getElementById('dominant-species-text');
            
            dominantSpeciesResultDiv.classList.add('hidden'); 

            if (allCorrect) {
                // V14: í•©ê³„ë„ í™•ì¸í•©ë‹ˆë‹¤.
                const sumD_input = parseFloat(document.getElementById('sum-D').textContent);
                const sumF_input = parseFloat(document.getElementById('sum-F').textContent);
                const sumC_input = parseFloat(document.getElementById('sum-C').textContent);
                const sumRD_input = parseFloat(document.getElementById('sum-RD').textContent);
                const sumRF_input = parseFloat(document.getElementById('sum-RF').textContent);
                const sumRC_input = parseFloat(document.getElementById('sum-RC').textContent);
                const sumIV_input = parseFloat(document.getElementById('sum-IV').textContent);
                
                const correctSums = correctStep2Answers.sums;
                const tolerance = ROUNDING_TOLERANCE; // í•©ê³„ì—ë„ ë™ì¼ ì˜¤ì°¨ ì ìš©

                // ê¸°ë³¸ ì¸¡ì •ì¹˜ í•©ê³„ í™•ì¸ (D, F, Cv)
                const isSumCorrect = 
                    (isNaN(sumD_input) || Math.abs(sumD_input - correctSums.sumD) < tolerance) &&
                    (isNaN(sumF_input) || Math.abs(sumF_input - correctSums.sumF) < tolerance) &&
                    (isNaN(sumC_input) || Math.abs(sumC_input - correctSums.sumCv) < tolerance) &&
                    // FIX 2: ìƒëŒ€ê°’ í•©ê³„ (RD, RF, RC)ë¥¼ ê³„ì‚°ëœ ì •ë‹µ í•©ê³„(correctSums)ì™€ ë¹„êµ
                    (isNaN(sumRD_input) || Math.abs(sumRD_input - correctSums.sumRD) < tolerance) && 
                    (isNaN(sumRF_input) || Math.abs(sumRF_input - correctSums.sumRF) < tolerance) && 
                    (isNaN(sumRC_input) || Math.abs(sumRC_input - correctSums.sumRC) < tolerance) && 
                    // ì¤‘ìš”ì¹˜ í•©ê³„ í™•ì¸ (ì‹¤ì œë¡œ ê³„ì‚°ëœ IV í•©ê³„ë¥¼ í™•ì¸)
                    (isNaN(sumIV_input) || Math.abs(sumIV_input - correctSums.sumIV) < tolerance)
                    ;

                if (isSumCorrect) {
                    resultMessage.textContent = `ğŸŒŸ ì™„ë²½í•´ìš”! ëª¨ë“  ê³„ì‚°ì´ ì •í™•í•©ë‹ˆë‹¤.`;
                    resultMessage.classList.remove('bg-white', 'bg-red-200', 'text-gray-800', 'border-dashed');
                    resultMessage.classList.add('bg-green-200', 'text-green-800', 'border-solid', 'border-green-400');

                    // V13: ì¤‘ìš”ì¹˜ ê²°ê³¼ë„ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ í‘œê¸°
                    dominantSpeciesText.innerHTML = `ì¤‘ìš”ì¹˜(${maxIV.toFixed(2)})ê°€ ê°€ì¥ ë†’ì€ ì¢…ì€ ë°”ë¡œ **${dominantSpecies} ${speciesInfo[dominantSpecies].symbol}** ì…ë‹ˆë‹¤!`;
                    dominantSpeciesResultDiv.classList.remove('hidden');
                } else {
                    // ê°œë³„ ì¸¡ì •ì¹˜ëŠ” ë§ì•˜ë”ë¼ë„ í•©ê³„ê°€ í‹€ë ¸ìœ¼ë©´ ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬
                    allCorrect = false;
                }

            } 
            
            if (!allCorrect) {
                resultMessage.textContent = `ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”. (${correctCount}/${totalMetrics} ì •ë‹µ) ëª¨ë“  ì¸¡ì •ì¹˜ì™€ í•©ê³„ê°€ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”.`;
                resultMessage.classList.remove('bg-white', 'bg-green-200', 'text-green-800', 'border-dashed');
                resultMessage.classList.add('bg-red-200', 'text-red-800', 'border-solid', 'border-red-400');
            }
        }

        // ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeGame() {
            // ëª¨ë“  ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '';
                input.classList.remove('correct', 'incorrect');
            });
            
            generateRandomLocations(); 
            correctRawDataForGame = getCorrectRawData(); 
            correctStep2Answers = calculateCorrectAnswers(); 

            drawQuadratMap(); 
            renderRawDataTable(); 
            renderCalcTable(); 
            
            document.getElementById('step2-container').style.display = 'none';
            document.getElementById('check-step1').disabled = false;
            document.getElementById('check-step1').classList.replace('bg-gray-400', 'bg-green-500');
            document.getElementById('step1-message').textContent = '';
            document.getElementById('step1-message').classList.remove('text-red-600', 'text-green-600');
            
            document.getElementById('step2-message').textContent = 'ê³„ì‚° ê²°ê³¼ë¥¼ ì…ë ¥í•˜ê³  í™•ì¸í•˜ì„¸ìš”.';
            document.getElementById('step2-message').classList.remove('bg-red-200', 'bg-green-200', 'text-red-800', 'text-green-800', 'border-solid', 'border-red-400', 'border-green-400');
            document.getElementById('step2-message').classList.add('bg-white', 'text-gray-800', 'border-2', 'border-dashed', 'border-gray-300');
            document.getElementById('dominant-species-result').classList.add('hidden');

            // V14: ì´ˆê¸°í™” ì‹œ í•©ê³„ë„ ì§€ì›ë‹ˆë‹¤.
            updateStep2Sums();
        }


        window.onload = initializeGame;

    </script>
</body>
</html>
